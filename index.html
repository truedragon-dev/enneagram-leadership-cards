<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5VFNX8QJB3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5VFNX8QJB3');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enneagram Leadership Cards v26</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Leadership Cards">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: auto;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* Navigation Styles - Fixed for iOS */
        .navigation {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 0;
            margin: -40px -40px 30px -40px;
            border-radius: 20px 20px 0 0;
            z-index: 100;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 20px;
        }

        .nav-button {
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Type-specific navigation button colors */
        .nav-button[data-type="1"] { background: #e76f51; }
        .nav-button[data-type="2"] { background: #4a9b4a; }
        .nav-button[data-type="3"] { background: #2d6a4f; }
        .nav-button[data-type="4"] { background: #4a9b8e; }
        .nav-button[data-type="5"] { background: #1e6091; }
        .nav-button[data-type="6"] { background: #6a4c93; }
        .nav-button[data-type="7"] { background: #457b9d; }
        .nav-button[data-type="8"] { background: #a63446; }
        .nav-button[data-type="9"] { background: #b8956a; }

        .nav-button.experiment {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #764ba2;
            padding: 8px 12px;
        }

        .nav-button.experiment:hover {
            background: linear-gradient(135deg, #9f7aea 0%, #553c9a 100%);
            color: white;
            border-color: transparent;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            color: #4a5568;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2em;
            color: #718096;
            margin-bottom: 20px;
            font-style: italic;
        }

        .instructions {
            text-align: center;
            font-size: 1em;
            color: #4a5568;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .card-container {
            perspective: 1000px;
            height: 950px;
            scroll-margin-top: 120px;
        }

        /* iOS-optimized focus animation */
        .card-container.focused {
            animation: cardFocus 0.8s ease-out;
        }

        @keyframes cardFocus {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
            40% {
                transform: scale(1.01);
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0.15);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.8s ease;
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            background: white;
            border-left: 6px solid;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }

        .type-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .type-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-right: 15px;
            opacity: 0.8;
        }

        .type-name {
            font-size: 1.4em;
            font-weight: 600;
            color: #2d3748;
        }

        .section {
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        .section-content {
            line-height: 1.5;
            font-size: 0.9em;
        }

        .field-question {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 1em;
            line-height: 1.6;
        }

        .field-question:last-of-type {
            margin-bottom: 0;
        }

        .field-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .attribution {
            font-size: 0.75em;
            color: #9ca3af;
            font-style: italic;
            text-align: center;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: auto;
        }

        .flip-indicator {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 0.9em;
            color: #4a5568;
            text-align: center;
            font-weight: 500;
            border: 2px dashed rgba(102, 126, 234, 0.3);
            margin-top: 20px;
        }

        .core-drive { color: #e53e3e; }
        .leads-through { color: #38a169; }
        .interaction-style { color: #3182ce; }
        .shadow-watch { color: #d69e2e; }
        .growth-edge { color: #805ad5; }

        .experiment-card {
            border-left-color: #9f7aea !important;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%) !important;
        }

        .experiment-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            justify-content: center;
        }

        .experiment-icon {
            font-size: 2.5em;
            margin-right: 15px;
        }

        .experiment-title {
            font-size: 1.6em;
            font-weight: 600;
            color: #553c9a;
        }

        .experiment-content {
            margin-bottom: 20px;
        }

        .current-experiment {
            background: rgba(159, 122, 234, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #9f7aea;
        }

        .experiment-label {
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #553c9a;
            margin-bottom: 10px;
        }

        .experiment-practice {
            font-size: 1.1em;
            line-height: 1.5;
            color: #2d3748;
            font-weight: 500;
        }

        .experiment-instructions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .step-number {
            background: #9f7aea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-text {
            font-size: 0.95em;
            line-height: 1.4;
            color: #4a5568;
        }

        .experiment-examples {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .example-card {
            background: rgba(159, 122, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #9f7aea;
        }

        .example-type {
            font-size: 0.9em;
            font-weight: 600;
            color: #553c9a;
            margin-bottom: 8px;
        }

        .example-text {
            font-size: 0.9em;
            line-height: 1.5;
            color: #2d3748;
        }

        /* Type-specific colors */
        .type-1 { border-left-color: #e76f51; }
        .type-2 { border-left-color: #4a9b4a; }
        .type-3 { border-left-color: #2d6a4f; }
        .type-4 { border-left-color: #4a9b8e; }
        .type-5 { border-left-color: #1e6091; }
        .type-6 { border-left-color: #6a4c93; }
        .type-7 { border-left-color: #457b9d; }
        .type-8 { border-left-color: #a63446; }
        .type-9 { border-left-color: #b8956a; }

        .type-1 .type-number { color: #e76f51; }
        .type-2 .type-number { color: #4a9b4a; }
        .type-3 .type-number { color: #2d6a4f; }
        .type-4 .type-number { color: #4a9b8e; }
        .type-5 .type-number { color: #1e6091; }
        .type-6 .type-number { color: #6a4c93; }
        .type-7 .type-number { color: #457b9d; }
        .type-8 .type-number { color: #a63446; }
        .type-9 .type-number { color: #b8956a; }

        .type-1 .field-question { border-left-color: #e76f51; }
        .type-2 .field-question { border-left-color: #4a9b4a; }
        .type-3 .field-question { border-left-color: #2d6a4f; }
        .type-4 .field-question { border-left-color: #4a9b8e; }
        .type-5 .field-question { border-left-color: #1e6091; }
        .type-6 .field-question { border-left-color: #6a4c93; }
        .type-7 .field-question { border-left-color: #457b9d; }
        .type-8 .field-question { border-left-color: #a63446; }
        .type-9 .field-question { border-left-color: #b8956a; }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .navigation {
                margin: -20px -20px 20px -20px;
            }
            
            .nav-buttons {
                gap: 6px;
                padding: 0 10px;
            }
            
            .nav-button {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .nav-button.experiment {
                padding: 8px 10px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .card-container {
                height: 850px;
                scroll-margin-top: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Header -->
        <div class="navigation">
          <div class="nav-buttons">
    <button class="nav-button" data-type="1" onclick="scrollToCard(1)">1</button>
    <button class="nav-button" data-type="2" onclick="scrollToCard(2)">2</button>
    <button class="nav-button" data-type="3" onclick="scrollToCard(3)">3</button>
    <button class="nav-button" data-type="4" onclick="scrollToCard(4)">4</button>
    <button class="nav-button" data-type="5" onclick="scrollToCard(5)">5</button>
    <button class="nav-button" data-type="6" onclick="scrollToCard(6)">6</button>
    <button class="nav-button" data-type="7" onclick="scrollToCard(7)">7</button>
    <button class="nav-button" data-type="8" onclick="scrollToCard(8)">8</button>
    <button class="nav-button" data-type="9" onclick="scrollToCard(9)">9</button>
    <button class="nav-button experiment" onclick="scrollToCard('experiment')">‚ö°</button>
</div>
        </div>

        <h1>Enneagram Leadership Cards</h1>
        <p class="subtitle">Individual Awareness & Higher Team IQ</p>
        <div class="instructions">
            <strong>Click any card to flip between individual patterns and team intelligence questions.</strong><br>
            Use the team intelligence side to elevate your collective thinking in real time.
        </div>

        <div class="grid" id="cardGrid">
            <!-- Cards will be populated by JavaScript -->
        </div>
    </div>

    <script>
        // Application state management
        class EnneagramApp {
            constructor() {
                this.initialized = false;
                this.observers = [];
                this.timers = [];
                this.eventHandlers = new Map();
                this.scrollManager = new ScrollManager();
                this.analytics = new AnalyticsManager();
                
                // Bind methods to maintain context
                this.handleCardFlip = this.handleCardFlip.bind(this);
                this.cleanup = this.cleanup.bind(this);
            }

            init() {
                if (this.initialized) {
                    console.warn('App already initialized');
                    return;
                }

                try {
                    this.renderCards();
                    this.setupEventListeners();
                    this.setupPWA();
                    this.analytics.init();
                    this.scrollManager.addCallback(() => this.flipBackVisibleCards());
                    
                    this.initialized = true;
                    console.log('Enneagram app initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize app:', error);
                    this.showErrorMessage();
                }
            }

            renderCards() {
                const grid = document.getElementById('cardGrid');
                if (!grid) {
                    throw new Error('Card grid element not found');
                }
                
                const typeCards = enneagramData.map(data => this.createCard(data)).join('');
                const experimentCard = this.createExperimentCard();
                
                grid.innerHTML = typeCards + experimentCard;
            }

            createCard(data) {
                return `
                    <div class="card-container" data-card="${data.number}">
                        <div class="card type-${data.number}" data-type="${data.number}">
                            <div class="card-face type-${data.number}">
                                <div class="type-header">
                                    <div class="type-number">${data.number}</div>
                                    <div class="type-name">${data.type.replace(/Type \d+‚Äî/, '')}</div>
                                </div>
                                
                                <div class="section">
                                    <div class="section-title core-drive">Core Drive</div>
                                    <div class="section-content">${data.coreDrive}</div>
                                </div>
                                
                                <div class="section">
                                    <div class="section-title leads-through">Leadership Gifts</div>
                                    <div class="section-content">${data.leadsThrough}</div>
                                </div>
                                
                                <div class="section">
                                    <div class="section-title interaction-style">Interaction Style</div>
                                    <div class="section-content">${data.interactionStyle}</div>
                                </div>
                                
                                <div class="section">
                                    <div class="section-title shadow-watch">Shadow Watch</div>
                                    <div class="section-content">${data.shadowWatch}</div>
                                </div>
                                
                                <div class="section">
                                    <div class="section-title growth-edge">Growth Edge</div>
                                    <div class="section-content">${data.growthEdge}</div>
                                </div>
                                
                                <div class="flip-indicator">Click to flip ‚Üí</div>
                                
                                <div class="attribution">
                                    created by allan @ truedragon.io
                                </div>
                            </div>
                            
                            <div class="card-face card-back type-${data.number}">
                                <div class="type-header">
                                    <div class="type-number">${data.number}</div>
                                    <div class="type-name">${data.type.replace(/Type \d+‚Äî/, '')}</div>
                                </div>
                                
                                <div class="field-title">Questions for Higher Team IQ</div>
                                
                                ${data.fieldQuestions.map(question => 
                                    `<div class="field-question">${question}</div>`
                                ).join('')}
                                
                                <div class="flip-indicator">‚Üê Click to flip back</div>
                                
                                <div class="attribution">
                                    created by allan @ truedragon.io
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

createExperimentCard() {
  return `
    <div class="card-container" data-card="experiment">
      <div class="card experiment-card" data-type="experiment">

        <!-- FRONT -->
        <div class="card-face experiment-card">
          <div class="experiment-header">
            <div class="experiment-icon">‚ö°</div>
            <div class="experiment-title">This Week‚Äôs Field Experiment</div>
          </div>

          <div class="experiment-content">
            <div class="experiment-practice">
              Let‚Äôs use the edge of one person‚Äôs growth as the whole team‚Äôs experiment.<br><br>
              Choose an edge someone‚Äôs working on. Practice it together.  
              Not as a task‚Äî*as a mirror.* See what it reveals in the field.
            </div>

            <div class="experiment-instructions">
              <div class="instruction-step"><strong>1.</strong> Name a live edge‚Äînot just a type, but a tension that‚Äôs present.</div>
              <div class="instruction-step"><strong>2.</strong> Translate it into a behavior the whole team can try this week.</div>
              <div class="instruction-step"><strong>3.</strong> Track what changes: energy, conflict, clarity, silence.</div>
              <div class="instruction-step"><strong>4.</strong> Debrief Friday: What did it stir up? What moved?</div>
            </div>
          </div>

          <div class="flip-indicator">Click to see edge-based examples ‚Üí</div>
          <div class="attribution">designed by allan @ truedragon.io</div>
        </div>

        <!-- BACK -->
        <div class="card-face card-back experiment-card">
          <div class="experiment-header">
            <div class="experiment-icon">üí°</div>
            <div class="experiment-title">Try One of These</div>
          </div>

          <div class="experiment-examples">
            <div class="example-card"><strong>Type 1 Edge:</strong> Act before we‚Äôre ready. This week: ship it at 80%.</div>
            <div class="example-card"><strong>Type 2 Edge:</strong> Make a direct request. This week: ask for what you need.</div>
            <div class="example-card"><strong>Type 3 Edge:</strong> Show the messy middle. This week: share something in-progress.</div>
            <div class="example-card"><strong>Type 4 Edge:</strong> Speak the unspoken. This week: name what feels emotionally real.</div>
            <div class="example-card"><strong>Type 5 Edge:</strong> Reveal your thinking early. This week: show your draft.</div>
            <div class="example-card"><strong>Type 6 Edge:</strong> Move before you're certain. This week: act on instinct once a day.</div>
            <div class="example-card"><strong>Type 7 Edge:</strong> Stay in the hard part. This week: don‚Äôt reframe. Just stay.</div>
            <div class="example-card"><strong>Type 8 Edge:</strong> Say ‚ÄúI don‚Äôt know‚Äù out loud. Let others lead for a moment.</div>
            <div class="example-card"><strong>Type 9 Edge:</strong> Speak your true take. This week: lean into one hard truth.</div>
          </div>

          <div class="flip-indicator">‚Üê Flip back</div>
          <div class="attribution">designed by allan @ truedragon.io</div>
        </div>
      </div>
    </div>
  `;
}

                document.addEventListener('click', cardClickHandler);
                this.eventHandlers.set('cardClick', cardClickHandler);

                // Keyboard handler
                const keyHandler = (e) => {
                    this.analytics.resetInactivityTimer();
                };

                document.addEventListener('keypress', keyHandler);
                this.eventHandlers.set('keypress', keyHandler);

                // Cleanup on page unload
                window.addEventListener('beforeunload', this.cleanup);
                this.eventHandlers.set('beforeunload', this.cleanup);
            }

            handleCardFlip(card) {
                try {
                    card.classList.toggle('flipped');
                    this.analytics.resetInactivityTimer();
                    
                    const typeAttr = card.getAttribute('data-type');
                    const enneagramType = typeAttr || 'experiment';
                    
                    setTimeout(() => {
                        const isShowingTeam = card.classList.contains('flipped');
                        const currentSide = isShowingTeam ? 'team' : 'individual';
                        this.analytics.trackCardFlip(enneagramType, currentSide);
                    }, 50);
                } catch (error) {
                    console.error('Error handling card flip:', error);
                }
            }

            flipBackVisibleCards() {
                try {
                    const flippedCards = document.querySelectorAll('.card.flipped');
                    if (flippedCards.length === 0) return;

                    flippedCards.forEach(card => {
                        // Only flip back if card is completely out of view (not partially visible)
                        // This prevents flipping back when user scrolls within a card to read content
                        if (this.isElementCompletelyOutOfView(card)) {
                            card.classList.remove('flipped');
                        }
                    });
                } catch (error) {
                    console.error('Error flipping back cards:', error);
                }
            }

            isElementInViewport(el) {
                const rect = el.getBoundingClientRect();
                return (rect.top < window.innerHeight && rect.bottom > 0);
            }

            isElementCompletelyOutOfView(el) {
                const rect = el.getBoundingClientRect();
                // Card is completely out of view if:
                // - Top is below the viewport bottom (scrolled past it)
                // - Bottom is above the viewport top (scrolled before it)
                // Add buffer zones to prevent premature flipping
                const buffer = 100; // 100px buffer
                return (
                    rect.top > window.innerHeight + buffer || 
                    rect.bottom < -buffer
                );
            }

            setupPWA() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/enneagram-leadership-cards/sw.js')
                        .then(registration => console.log('SW registered:', registration))
                        .catch(error => console.log('SW registration failed:', error));
                }

                this.setupInstallPrompt();
            }

            setupInstallPrompt() {
                let deferredPrompt;
                const installButton = document.createElement('button');
                installButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #764ba2;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    display: none;
                `;
                installButton.textContent = 'üì± Install App';
                document.body.appendChild(installButton);

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    installButton.style.display = 'block';
                });

                installButton.addEventListener('click', () => {
                    installButton.style.display = 'none';
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(() => {
                            deferredPrompt = null;
                        });
                    }
                });

                window.addEventListener('appinstalled', () => {
                    installButton.style.display = 'none';
                });
            }

            showErrorMessage() {
                const grid = document.getElementById('cardGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #721c24; background: #f8d7da; border-radius: 10px;">
                            <h3>Something went wrong</h3>
                            <p>Please refresh the page to try again.</p>
                        </div>
                    `;
                }
            }

            cleanup() {
                try {
                    // Clean up observers
                    this.observers.forEach(observer => {
                        if (observer && typeof observer.disconnect === 'function') {
                            observer.disconnect();
                        }
                    });
                    this.observers = [];

                    // Clear timers
                    this.timers.forEach(timer => clearTimeout(timer));
                    this.timers = [];

                    // Remove event listeners
                    this.eventHandlers.forEach((handler, event) => {
                        if (event === 'beforeunload') {
                            window.removeEventListener('beforeunload', handler);
                        } else {
                            document.removeEventListener(event, handler);
                        }
                    });
                    this.eventHandlers.clear();

                    // Cleanup scroll manager
                    if (this.scrollManager) {
                        this.scrollManager.cleanup();
                    }

                    // Cleanup analytics
                    if (this.analytics) {
                        this.analytics.cleanup();
                    }

                    this.initialized = false;
                    console.log('App cleanup completed');
                } catch (error) {
                    console.error('Error during cleanup:', error);
                }
            }
        }

        // Scroll Management
        class ScrollManager {
            constructor() {
                this.callbacks = [];
                this.throttleTimer = null;
                this.handleScroll = this.handleScroll.bind(this);
                this.init();
            }

            init() {
                window.addEventListener('scroll', this.handleScroll, { passive: true });
            }

            addCallback(callback) {
                if (typeof callback === 'function') {
                    this.callbacks.push(callback);
                }
            }

            handleScroll() {
                if (!this.throttleTimer) {
                    this.throttleTimer = setTimeout(() => {
                        this.callbacks.forEach(callback => {
                            try {
                                callback();
                            } catch (error) {
                                console.error('Error in scroll callback:', error);
                            }
                        });
                        this.throttleTimer = null;
                    }, 100);
                }
            }

            cleanup() {
                window.removeEventListener('scroll', this.handleScroll);
                if (this.throttleTimer) {
                    clearTimeout(this.throttleTimer);
                    this.throttleTimer = null;
                }
                this.callbacks = [];
            }
        }

        // Analytics Management
        class AnalyticsManager {
            constructor() {
                this.cardSession = {
                    startTime: Date.now(),
                    totalFlips: 0,
                    individualViews: 0,
                    teamViews: 0,
                    typesViewed: new Set(),
                    lastFlipTime: Date.now()
                };

                this.viewedCards = new Set();
                this.cardEngagementTimes = new Map();
                this.currentlyViewedCards = new Map();
                this.viewObserver = null;
                this.inactivityTimer = null;
            }

            init() {
                try {
                    this.setupViewTracking();
                    this.trackPageLoad();
                } catch (error) {
                    console.error('Analytics initialization failed:', error);
                }
            }

            setupViewTracking() {
                if ('IntersectionObserver' in window) {
                    this.viewObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            try {
                                if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                                    this.trackCardView(entry.target);
                                } else if (!entry.isIntersecting) {
                                    this.trackCardExit(entry.target);
                                }
                            } catch (error) {
                                console.error('Error in intersection observer:', error);
                            }
                        });
                    }, {
                        threshold: [0, 0.5]
                    });

                    // Observe cards after a short delay to ensure they're rendered
                    setTimeout(() => {
                        const cards = document.querySelectorAll('.card');
                        cards.forEach(card => {
                            if (this.viewObserver) {
                                this.viewObserver.observe(card);
                            }
                        });
                    }, 500);
                }
            }

            trackCardFlip(enneagramType, newSide) {
                try {
                    this.cardSession.totalFlips++;
                    this.cardSession.typesViewed.add(enneagramType);
                    this.cardSession.lastFlipTime = Date.now();
                    
                    if (newSide === 'individual') {
                        this.cardSession.individualViews++;
                    } else if (newSide === 'team') {
                        this.cardSession.teamViews++;
                    }
                    
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'card_flip', {
                            'event_category': 'card_interaction',
                            'event_label': `type_${enneagramType}_to_${newSide}`,
                            'enneagram_type': enneagramType,
                            'side_shown': newSide,
                            'total_flips': this.cardSession.totalFlips,
                            'session_duration': Math.round((Date.now() - this.cardSession.startTime) / 1000)
                        });
                    }
                } catch (error) {
                    console.error('Error tracking card flip:', error);
                }
            }

            trackCardView(card) {
                try {
                    const typeMatch = card.className.match(/type-(\d+)/);
                    const enneagramType = typeMatch ? typeMatch[1] : 'experiment';
                    
                    this.currentlyViewedCards.set(enneagramType, Date.now());
                    
                    if (!this.viewedCards.has(enneagramType)) {
                        this.viewedCards.add(enneagramType);
                        
                        if (typeof gtag !== 'undefined') {
                            gtag('event', 'card_viewed', {
                                'event_category': 'card_exposure',
                                'event_label': `type_${enneagramType}_viewed`,
                                'enneagram_type': enneagramType,
                                'side_shown': 'individual',
                                'view_method': 'scroll'
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error tracking card view:', error);
                }
            }

            trackCardExit(card) {
                try {
                    const typeMatch = card.className.match(/type-(\d+)/);
                    const enneagramType = typeMatch ? typeMatch[1] : 'experiment';
                    
                    if (this.currentlyViewedCards.has(enneagramType)) {
                        const startTime = this.currentlyViewedCards.get(enneagramType);
                        const timeSpent = Math.round((Date.now() - startTime) / 1000);
                        
                        if (timeSpent >= 2) {
                            const existingTime = this.cardEngagementTimes.get(enneagramType) || 0;
                            this.cardEngagementTimes.set(enneagramType, existingTime + timeSpent);
                            
                            if (typeof gtag !== 'undefined') {
                                gtag('event', 'card_engagement_time', {
                                    'event_category': 'card_engagement',
                                    'event_label': `type_${enneagramType}_${timeSpent}s`,
                                    'enneagram_type': enneagramType,
                                    'engagement_seconds': timeSpent,
                                    'total_card_time': this.cardEngagementTimes.get(enneagramType)
                                });
                            }
                        }
                        
                        this.currentlyViewedCards.delete(enneagramType);
                    }
                } catch (error) {
                    console.error('Error tracking card exit:', error);
                }
            }

            trackSessionSummary() {
                try {
                    const sessionDuration = Math.round((this.cardSession.lastFlipTime - this.cardSession.startTime) / 1000);
                    const preferredSide = this.cardSession.individualViews > this.cardSession.teamViews ? 'individual' : 'team';
                    
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'session_summary', {
                            'session_duration': sessionDuration,
                            'total_flips': this.cardSession.totalFlips,
                            'unique_types': this.cardSession.typesViewed.size,
                            'preferred_side': preferredSide,
                            'individual_views': this.cardSession.individualViews,
                            'team_views': this.cardSession.teamViews
                        });
                    }
                } catch (error) {
                    console.error('Error tracking session summary:', error);
                }
            }

            trackPageLoad() {
                try {
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'page_load', {
                            'page_title': document.title,
                            'page_location': window.location.href
                        });
                    }
                } catch (error) {
                    console.error('Error tracking page load:', error);
                }
            }

            resetInactivityTimer() {
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                }
                this.inactivityTimer = setTimeout(() => {
                    this.trackSessionSummary();
                }, 30000);
            }

            cleanup() {
                try {
                    // Track final engagement for currently viewed cards
                    this.currentlyViewedCards.forEach((startTime, enneagramType) => {
                        const timeSpent = Math.round((Date.now() - startTime) / 1000);
                        if (timeSpent >= 2) {
                            const existingTime = this.cardEngagementTimes.get(enneagramType) || 0;
                            this.cardEngagementTimes.set(enneagramType, existingTime + timeSpent);
                            
                            if (typeof gtag !== 'undefined') {
                                gtag('event', 'final_card_engagement', {
                                    'event_category': 'session_end',
                                    'enneagram_type': enneagramType,
                                    'engagement_seconds': timeSpent,
                                    'total_card_time': this.cardEngagementTimes.get(enneagramType)
                                });
                            }
                        }
                    });
                    
                    this.trackSessionSummary();
                    
                    if (this.viewObserver) {
                        this.viewObserver.disconnect();
                        this.viewObserver = null;
                    }
                    
                    if (this.inactivityTimer) {
                        clearTimeout(this.inactivityTimer);
                        this.inactivityTimer = null;
                    }
                } catch (error) {
                    console.error('Error during analytics cleanup:', error);
                }
            }
        }

        // Navigation Functions (Global scope for onclick handlers)
        function scrollToCard(cardNumber) {
            try {
                const cardElement = document.querySelector(`[data-card="${cardNumber}"]`);
                if (!cardElement) {
                    console.error('Card element not found for:', cardNumber);
                    return;
                }
                
                // Remove focus from all cards
                document.querySelectorAll('.card-container').forEach(card => {
                    card.classList.remove('focused');
                });
                
                // Use native scrollIntoView for iOS compatibility
                cardElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Add focus animation after scroll completes
                setTimeout(() => {
                    cardElement.classList.add('focused');
                }, 600);
            } catch (error) {
                console.error('Error scrolling to card:', error);
            }
        }

        // Enneagram Data
        const enneagramData = [
            {
                type: "Type 1‚ÄîThe Strict Perfectionist",
                number: "1",
                coreDrive: "Driven to do what's right and improve the world while avoiding mistakes, blame, or being seen as corrupt or defective.",
                leadsThrough: "Integrity, responsibility, attention to detail, organization, and pragmatism",
                interactionStyle: "Principled, firm, composed. Leads with structure and standards. Can become rigid under chaos or inefficiency.",
                shadowWatch: "When I'm in shadow, I can create a field where others feel like they're walking on eggshells, anticipating criticism and judgment. This happens even when I think I'm being helpful by pointing out what needs to be fixed.",
                growthEdge: "Act on what's good enough before you know it's right, and stay with it long enough to discover that effectiveness can emerge from iteration, not just perfection.",
                fieldQuestions: [
                    "Where is perfectionism blocking our progress? (Watch Your Shadow)",
                    "Are we focusing on being right or being effective? (Watch Your Shadow)",
                    "What's working well that we should protect and build on? (Offer Your Gifts)",
                    "What standards are serving us vs. limiting us right now? (Offer Your Gifts)"
                ]
            },
            {
                type: "Type 2‚ÄîThe Considerate Helper",
                number: "2",
                coreDrive: "Seeks love and connection by meeting others' needs while avoiding rejection, being seen as inadequate, or feeling unneeded.",
                leadsThrough: "Motivation, relational inelligence, supportiveness, and resourcefulness",
                interactionStyle: "Warm, attentive, relationally attuned. Prioritizes others' needs and rapport. May over-accommodate or avoid direct asks.",
                shadowWatch: "When I'm in shadow, I can make others feel guilty for having needs I can't meet or for not appreciating my efforts enough. This happens even when I think I'm being selflessly supportive.",
                growthEdge: "Ask directly for what you need before ensuring others are taken care of, and stay with it long enough to discover that others can stay connected even when you prioritize yourself.",
                fieldQuestions: [
                    "Who's feeling guilty or obligated rather than genuinely committed? (Watch Your Shadow)",
                    "Where are we hinting at needs instead of asking directly? (Watch Your Shadow)",
                    "Who's not being heard or cared for right now? (Offer Your Gifts)",
                    "Are we attending to relationships while pursuing our goals? (Offer Your Gifts)"
                
                ]
            },
            {
                type: "Type 3‚ÄîThe Competitive Achiever",
                number: "3",
                coreDrive: "Pursues achievement and recognition to feel valued while avoiding failure, inefficiency, or being seen as unsuccessful or unworthy.",
                leadsThrough: "Focus, clear goals, entrepreneurial spirit, and can-do energy",
                interactionStyle: "Polished, focused, efficient. Orients to goals and recognition. Can bypass emotional nuance in pursuit of performance.",
                shadowWatch: "When I'm in shadow, I can create a pace that others can't sustain and make process feel less important than results. This happens even when I think I'm being appropriately focused and efficient.",
                growthEdge: "Show up authentically messy before you feel polished enough, and stay with it long enough to discover that people can value your realness more than your performance.",
                fieldQuestions: [
                    "Are we optimizing for real impact or just looking successful? (Watch Your Shadow)",
                    "Are we including all voices in our drive toward goals? (Watch Your Shadow)",
                    "How can we channel our momentum more effectively? (Offer Your Gifts)",
                    "What's the right pace to sustain our progress? (Offer Your Gifts)"
               
                    
                ]
            },
            {
                type: "Type 4‚ÄîThe Intense Creative",
                number: "4",
                coreDrive: "Strives for authenticity and emotional depth while avoiding being misunderstood, mundane, or emotionally insignificant.",
                leadsThrough: "Vision, creativity, compassion, and emotional depth",
                interactionStyle: "Expressive, introspective, emotionally honest. Seeks depth and resonance. May withdraw if authenticity feels threatened.",
                shadowWatch: "When I'm in shadow, I can create a field where others feel they can't be authentic enough or that their concerns are too ordinary. This happens even when I think I'm championing depth and meaning.",
                growthEdge: "Share what's ordinary and commonplace about your experience, and stay with it long enough to discover that connection can happen through shared humanity, not just specialness.",
                fieldQuestions: [
                    "Are we dismissing practical solutions because they feel too ordinary? (Watch Your Shadow)",
                    "Who might be feeling like their contribution isn't 'special' enough? (Watch Your Shadow)",
                    "What's missing from our conversation that needs to be named? (Offer Your Gifts)",
                    "Are we being authentic or just going through the motions? (Offer Your Gifts)"
              
                ]
            },
            {
                type: "Type 5‚ÄîThe Quiet Specialist",
                number: "5",
                coreDrive: "Seeks knowledge and clarity to maintain autonomy while avoiding intrusion, overwhelm, or appearing incompetent.",
                leadsThrough: "Expertise, analysis, objectivity, planning, and logic",
                interactionStyle: "Private, precise, observing. Engages from a distance. Shares selectively and prefers mental clarity over emotional messiness.",
                shadowWatch: "When I'm in shadow, I can withhold information and process, leaving others to fill in gaps with assumptions. This happens even when I think I'm being thorough and protecting the quality of my thinking.",
                growthEdge: "Share your thinking process before it's complete, and stay with it long enough to discover that others' input can enhance rather than contaminate your insights.",
                fieldQuestions: [
                    "Where is the desire for more information slowing us down? (Watch Your Shadow)",
                    "Who's withdrawing instead of engaging with the team? (Watch Your Shadow)",
                    "What are we not seeing because we're moving too fast? (Offer Your Gifts)",
                    "Where do we need more time to think before acting? (Offer Your Gifts)"
                 
                ]
            },
            {
                type: "Type 6‚ÄîThe Loyal Skeptic",
                number: "6",
                coreDrive: "Wants security and trust through loyalty and vigilance while avoiding uncertainty, blame, or being caught off guard.",
                leadsThrough: "Risk assessment, perseverance, collaboration, and foresight",
                interactionStyle: "Vigilant, loyal, questioning. Builds safety through inquiry and preparedness. Can oscillate between caution and pushback.",
                shadowWatch: "When I'm in shadow, I can create an atmosphere where others feel questioned, doubted, or that nothing is ever safe enough. This happens even when I think I'm being appropriately cautious and thorough.",
                growthEdge: "Act on your instinct before you have all the guarantees, and stay with it long enough to discover that security can come from trusting your inner knowing, not just external certainty.",
                fieldQuestions: [
                    "Are we stuck in endless questioning without deciding? (Watch Your Shadow)",
                    "Where is anxiety driving our decisions instead of wisdom? (Watch Your Shadow)",
                    "What risks are we not seeing or preparing for? (Offer Your Gifts)",
                    "Do we have enough support and backup plans? (Offer Your Gifts)"
                    
                ]
            },
            {
                type: "Type 7‚ÄîThe Enthusiastic Visionary",
                number: "7",
                coreDrive: "Pursues freedom, joy, and new possibilities while avoiding limitation, pain, or feeling trapped in discomfort.",
                leadsThrough: "Innovation, curiosity, energy, idea generation, and optimism",
                interactionStyle: "Upbeat, scattered, future-focused. Brings energy and ideas. May avoid hard emotions or prematurely pivot from discomfort.",
                shadowWatch: "When I'm in shadow, I can create a field where difficult emotions or problems get dismissed or glossed over too quickly. This happens even when I think I'm maintaining positive energy and forward momentum.",
                growthEdge: "Stay with difficulty and constraint long enough to let it teach you, and discover that depth can emerge from limitation, not just from endless options.",
                fieldQuestions: [
                    "Are we creating chaos by pursuing too many ideas at once? (Watch Your Shadow)",
                    "Who‚Äôs silently holding pain while we move forward with optimism? (Watch Your Shadow)",
                    "What possibilities are we not seeing or exploring? (Offer Your Gifts)",
                    "How can we bring more innovation to this challenge? (Offer Your Gifts)"
                ]
            },
            {
                type: "Type 8‚ÄîThe Active Controller",
                number: "8",
                coreDrive: "Driven to assert control and protect what matters while avoiding vulnerability, weakness, or being controlled by others.",
                leadsThrough: "Boldness, action, strategic influence, and candor",
                interactionStyle: "Bold, direct, intense. Commands attention and moves quickly to action. Can overpower or challenge before building buy-in.",
                shadowWatch: "When I'm in shadow, I can create a field where others feel steamrolled, unheard, or afraid to voice alternative perspectives. This happens even when I think I'm being appropriately direct and action-oriented.",
                growthEdge: "Show your uncertainty and ask for help before you feel strong enough, and stay with it long enough to discover that vulnerability can increase rather than diminish your influence.",
                fieldQuestions: [
                    "Are we steamrolling instead of building buy-in? (Watch Your Shadow)",
                    "What vulnerability, if modeled here, would unlock more truth from others? (Watch Your Shadow)",
                    "What are we avoiding that needs direct engagement? (Offer Your Gifts)",
                    "Who might be holding back their truth or perspective? (Offer Your Gifts)"
                    
                ]
            },
            {
                type: "Type 9‚ÄîThe Adaptive Peacemaker",
                number: "9",
                coreDrive: "Seeks peace, harmony, and internal stability while avoiding conflict, tension, or the discomfort of their own priorities.",
                leadsThrough: "Patience, consistency, diplomacy, and inclusion",
                interactionStyle: "Open, agreeable, unhurried. Tends to merge with group flow. May resist direct conflict or suppress inner priorities.",
                shadowWatch: "When I'm in shadow, I can create a vacuum where others have to carry all the tension and make the difficult decisions. This happens even when I think I'm being diplomatic and keeping the peace.",
                growthEdge: "Speak into the conflict that others are avoiding and stay with it long enough to discover that engaging tension can create deeper harmony than always avoiding it.",
                fieldQuestions: [
                    "Where are we avoiding conflict instead of engaging it? (Watch Your Shadow)",
                    "What silence in the room might actually be resistance or dissent? (Watch Your Shadow)",
                    "What tensions are we not addressing that need attention? (Offer Your Gifts)",
                    "Where does staying steady and consistent break us through? (Offer Your Gifts)"
                  
                ]
            }
        ];

        // Initialize the application when DOM is ready
        let app;
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                app = new EnneagramApp();
                app.init();
            } catch (error) {
                console.error('Failed to start application:', error);
            }
        });

        // Ensure cleanup happens even if page unloads quickly
        window.addEventListener('beforeunload', function() {
            if (app) {
                app.cleanup();
            }
        });
    </script>
</body>
</html>
